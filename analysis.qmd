---
title: "Data Analysis"
html:
  code-fold: true
  code-summary: "Show the code"
---

## Overview
Now that the data are cleaned and prepared, we can create our visualisation.
We need geometry data to create the map of Washington with county boundaries.
The fill value for each county will the be one of the dependency ratio created 
previously.

```{r setup}
#| message: false
#| code-fold: true
#| code-summary: "Show the code"
library(tidyverse)
library(sf)
library(tigris)
library(gt)
library(broom)
library(ggrepel)
theme_set(theme_minimal())
```

```{r read in county dataframe}
#| echo: false
df_counties <- read_rds("intermediate/df_countries_proced.rds")
```

```{r store year range in variables}
#| echo: false
years <- levels(df_counties$year)
start_year <- first(years)
last_year <- last(years)

start_year_num <- as.numeric(start_year)
last_year_num <- as.numeric(last_year)
```

## Statewide dependency ratios
As the chart and table below show, the total dependency ratio for the State is increasing. Child and aged dependency ratios are moving in opposite directions. Child dependency is decreasing slowly while the aged dependency ratio is increasing. The aged dependency ratio is driving the trend in total dependency over the `r last_year_num - start_year_num` years from `r start_year` to `r last_year`.

```{r statewide dependency ratios}
#| code-fold: true
#| code-summary: "Show the code"

df_counties |> 
  filter(geography == "Washington State") |> 
  select(-(age_65:age_1)) |> 
  pivot_longer(total_dep_ratio:aged_dep_ratio, names_to = "dep_ratio", values_to = "ratio_val") |> 
  mutate(
    dep_ratio = fct_rev(fct_recode(as_factor(dep_ratio), 
                             "Total" = "total_dep_ratio",
                             "Child" = "child_dep_ratio",
                             "Aged" = "aged_dep_ratio"))
  ) |> 
  ggplot(aes(x=year, y=ratio_val, fill=dep_ratio)) +
  geom_col(position = "dodge", colour="white") +
  labs(
    x = element_blank(),
    y = "Value",
    fill = "Dependency ratio",
    title = paste("Total dependency increases from", start_year, "to", last_year),
    subtitle = "Child and aged dependencies move in opposite directions"
  ) +
  theme(
    legend.position = "bottom"
  )
  
```
```{r table of DR values at state level}
#| code-fold: true
#| code-summary: "Show the code"
df_counties |> 
  filter(geography == "Washington State") |> 
  select( "Year"=year, "Child"=child_dep_ratio, "Aged"=aged_dep_ratio, "Total"=total_dep_ratio) |> 
  mutate(
    pct_change_total = round((Total - lag(Total, n=1))/lag(Total, n=1)*100, 2)
  ) |> 
  gt() |> 
  tab_header(
    title = paste("Changes in dependency ratios in Washington State,", start_year, "-", last_year)
  ) |> 
  cols_label(
    pct_change_total = "Percent Change Total"
  ) |> 
  tab_options(
    table.width = pct(100)
  )
  
```

### Understanding the total dependency ratio trend

In order to quantify how total dependency is changing in Washington a simple linear model was employed. The model indicates that in each subsequent year the total dependency ratio increases by about 0.67 and the intercept can be interpreted as the value of the total dependency ratio in 2010.

```{r TDR trends}
#| code-fold: true
#| code-summary: "Show the code"

lm_fit <- df_counties |> 
  filter(geography == "Washington State") |>
  mutate(
    year = as.numeric(year)
  ) |> 
  lm(total_dep_ratio ~ year, data = _)

model_estimates <- broom::tidy(lm_fit)

model_estimates |> 
  gt() |> 
  tab_header(
    title = "Simple linear model of total depency ratio"
  ) |> 
  fmt_number(
    decimals = 2
  )
```

The plot below shows the model fit and confidence interval.

```{r plot total dependency trend}
#| message: false
#| code-fold: true
#| code-summary: "Show the code"
df_counties |> 
  filter(geography == "Washington State") |>
  ggplot(aes(x=as.numeric(year), y=total_dep_ratio)) +
  geom_point() +
  geom_smooth(method="lm", se=TRUE) +
  scale_x_continuous(
    breaks = 1:11,
    minor_breaks = NULL,
    labels = as.character(2011:2021)
  ) +
  labs(
    title = paste("Washington State total dependecy ratio trend",start_year,"-",last_year),
    x = "Year",
    y = "Total dependency ratio"
  )
```
The confidence interval is very tight around the trend line.

### Prediciting future total dependency ratios
We can project this model forward a few years to see what total dependency ratios will be in subsequent years. When the 2022-23 demographic data become available, they can be compared with model predictions and the model can be updated.

```{r TDR predictions}
#| code-fold: true
#| code-summary: "Show the code"
# 2022 and 2023 are the 12th and 13th years in the series.
TDR_preds <- predict(lm_fit, newdata = data.frame(year = c(12,13)), type="response")
names(TDR_preds) <- c("2022", "2023")
round(TDR_preds,2)
```



## Counties with highest total dependency ratios
The table below shows the counties with the highest total dependency ratios in 2021. The counties in this list all have much higher aged dependency ratios than the statewide value (25.71) while generally having typical child dependency ratios. Jefferson county being the notable exception with a child dependency ratio of 18.58.

```{r identify high ratio counties}
#| code-fold: true
#| code-summary: "Show the code"

df_high_ratio <- df_counties |> 
  filter(geography != "Washington State" & year == 2021) |> 
  arrange(desc(total_dep_ratio)) |> 
  select("County"= geography, "Child"=child_dep_ratio, "Aged"=aged_dep_ratio, "Total"=total_dep_ratio) |>
  head(10)

df_high_ratio |> 
  gt() |> 
  tab_header(
    title = paste("Counties with highest dependency ratios in",last_year)
  ) |> 
  tab_options(
    table.width = pct(100)
  )
```

### Where these counties are located
In order to understand how dependency ratios vary across the state, shape files for the counties are imported and the dependency ratios are overlaid on a map of the state.

```{r create WA geometries}
#| message: false
#| code-fold: true
#| code-summary: "Show the code"
wa_county <- counties(state = "WA", cb = TRUE, class = "sf", progress_bar = FALSE)
```

```{r map high ratio counties}
#| warning: false
#| code-fold: true
#| code-summary: "Show the code"

label_size <- 3.5

wa_county |> 
  left_join(df_high_ratio, by=c("NAME"="County")) |>
  mutate(
    NAME = if_else(is.na(Total), "", NAME)
  ) |>
  ggplot() +
  geom_sf(aes(fill=Total), colour="white", ) +
  geom_label_repel(aes(label = NAME, geometry = geometry),
                  stat = "sf_coordinates", size = label_size) +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis",limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  labs(
    title="Counties with highest total dependency ratios in 2021",
    caption="Data source: Washington State County Demography Dashboard",
    fill="Total dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```
From this map, it is clear that the distribution of the high dependency counties is not random. They are located on the east/west extremes of the state. Furthermore, 5 of the top 6 are located on the west coast, while the other five are located in the eastern quarter of the state.

```{r map high ratio counties child dependency rates}
#| warning: false
#| code-fold: true
#| code-summary: "Show the code"
wa_county |> 
  left_join(df_high_ratio, by=c("NAME"="County")) |>
  mutate(
    NAME = if_else(is.na(Child), "", NAME)
  ) |>
  ggplot() +
  geom_sf(aes(fill=Child), colour="white", ) +
  geom_label_repel(aes(label = NAME, geometry = geometry),
                  stat = "sf_coordinates", size = label_size) +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis",limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  labs(
    title="Child dependency ratios for counties with highest\ntotal dependency ratios in 2021",
    caption="Data source: Washington State County Demography Dashboard",
    fill="Child dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```
These counties have roughly similar rates of child dependency, with Jefferson and San Juan Counties being notable exceptions. That said, there is a statistically significant difference, with $\alpha=0.05$, between the mean child dependency ratios of the west coast and eastern counties.

```{r comparing west coast and eastern counties child dependency ratios}

west_coast_CDR <- c(18.85, 24.40, 24.47, 24.55, 19.69)
eastern_CDR <- c(31.6, 30.61, 27.34, 25.46, 27.13)
state_CDR_mean <- 27.73

t.test(
  west_coast_CDR, # west coast counties
  eastern_CDR  # eastern counties
)
```
If we compare the west coast counties to the statewide mean, there is a statistically significant difference at the $\alpha=0.5$ significance level.

```{r testing west coast against statewide CDR}
t.test(
  x=west_coast_CDR,
  mu = state_CDR_mean
)
```
If we compare the eastern counties to the statewide mean, we can see that there is *not* a statistically significant difference at the $\alpha=0.5$ significance level.

```{r testing eastern counties against statewide CDR}
t.test(
  x=eastern_CDR,
  mu = state_CDR_mean
)
```

```{r map high ratio counties aged dependency rates}
#| warning: false
#| code-fold: true
#| code-summary: "Show the code"
wa_county |> 
  left_join(df_high_ratio, by=c("NAME"="County")) |>
  mutate(
    NAME = if_else(is.na(Aged), "", NAME)
  ) |>
  ggplot() +
  geom_sf(aes(fill=Aged), colour="white", ) +
  geom_label_repel(aes(label = NAME, geometry = geometry),
                  stat = "sf_coordinates", size = label_size) +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis",limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  labs(
    title="Aged dependency ratios for counties with highest\ntotal dependency ratios in 2021",
    caption="Data source: Washington State County Demography Dashboard",
    fill="Aged dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```
The same is true of the aged dependency ratio means for west coast and eastern counties. With $\alpha = 0.05$, there is a statistically significant different between the to two regions' counties.

```{r comparing west coast and eastern counties aged dependency ratios}
t.test(
  c(79.39, 66.51, 64.54, 62.54, 67.15), # west coast counties
  c(59.65, 53.93, 51.14, 52.23, 50.42)  # eastern counties
)
```
The aged dependency ratios for both county groups is so much higher than the statewide mean that performing a statistical test is unnecessary.

What this tells us is that among the counties with the highest total dependencies there are significant differences between these counties and the state as a whole and that there are regional differences between subgroups in these 10 counties.

### Modeling changes in total dependency


```{r build linear models}
#| message: false
#| code-fold: true
#| code-summary: "Show the code"
#| fig-width: 10
#| fig-height: 10

high_ratio_counties <- df_high_ratio |> 
  select(County) |> 
  pull()

df_county_models <- df_counties |> 
  filter(geography %in% high_ratio_counties) |> 
  select(-c(age_65:age_1, child_dep_ratio, aged_dep_ratio)) |>
  mutate(
    year = as.numeric(year)
  ) |> 
  group_by(geography) |> 
  nest() |> 
  mutate(
    model = map(.x=data, ~lm(total_dep_ratio ~ year, data=.x) |> tidy())
  )

df_county_models |> 
  unnest(data) |>
  ggplot(aes(x=year, y=total_dep_ratio)) +
  geom_point() +
  geom_smooth(method = "lm", se=TRUE) +
  facet_wrap(~geography, ncol=2) +
  scale_x_continuous(
    breaks = c(1:11),
    labels = as.character(2011:2021),
    minor_breaks = NULL,
  ) +
  labs(
    x=element_blank(),
    y="Total dependency ratio"
  ) +
  theme(
    axis.text.x = element_text(
      angle = 45
    )
  )
```

```{r table of model results}
#| code-fold: true
#| code-summary: "Show the code"

df_county_models |> 
  select(-data) |> 
  unnest(model) |>
  select(-statistic) |> 
  pivot_wider(names_from = term, values_from = estimate) |> 
  rename(Intercept = "(Intercept)", "Slope"=year) |> 
  filter(is.na(Intercept)) |> 
  select(-Intercept, County = "geography", Slope, "Std Error" = "std.error", "P Value"="p.value") |> 
  relocate(Slope, .before = "Std Error") |> 
  arrange(desc(Slope)) |> 
  ungroup() |> 
  gt() |> 
  tab_header(
    title = "Rates of change for total dependency ratio by county"
  ) |>
  fmt_number(
    decimals = 2
  ) |> 
  cols_align(
    align = "left",
    columns = County
  )
```


## Dependency ratios in Washington Counties




Inner join the geometries with the demographic data. This will allow us to generate maps that include county boundaries and the dependency ratios as fill data.

```{r join geometry and demographic data}
#| code-fold: true
#| code-summary: "Show the code"
df_joined <- wa_county |>
  inner_join(df_counties, by=c("NAME"="geography"))
```



### Child depenency ratio by county

```{r generate CDR map}
#| code-fold: true
#| code-summary: "Show the code"
df_joined |>
  ggplot() +
  geom_sf(aes(fill=child_dep_ratio), colour="white") +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis",limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  facet_wrap(~year) +
  labs(
    title="Child dependency ratios for Washington State counties",
    subtitle=paste("Ratios stay relatively flat from", start_year, "to", last_year, sep = " "),
    caption="Data source: Washington State County Demography Dashboard",
    fill="Child dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```



### Aged dependency ratio by county

```{r generate ADR map}
#| code-fold: true
#| code-summary: "Show the code"
df_joined |>
  ggplot() +
  geom_sf(aes(fill=aged_dep_ratio), colour="white") +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis", limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  facet_wrap(~year) +
  labs(
    title="Aged dependency ratios for Washington State counties",
    subtitle=paste("Ratios increase from", start_year, "to", last_year),
    caption="Data source: Washington State County Demography Dashboard",
    fill="Aged dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```

### Total dependency ratio by county
Create a faceted map that shows the evolution of total dependency ratio by county from 2011 to
2021.
```{r generate TDR map}
#| code-fold: true
#| code-summary: "Show the code"
df_joined |>
  ggplot() +
  geom_sf(aes(fill=total_dep_ratio), colour="white") +
  # for the same colour scale for all dependency maps with limits
  scale_fill_continuous(type = "viridis", limits=c(0, 100)) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  facet_wrap(~year) +
  labs(
    title="Total dependency ratios for Washington State counties",
    subtitle=paste("Ratios increase from", start_year, "to", last_year),
    caption="Data source: Washington State County Demography Dashboard",
    fill="Total dependency ratio"
  ) +
  theme(
    plot.caption.position = "plot",
    plot.title.position = "plot"
  )
```

<section class="button-container">
  <a href="conclusion.html" role="button" class="btn btn-primary">Continue to Conclusions</a>
</section>